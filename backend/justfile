# Backend Development Tasks

# Default recipe
default:
    @just --list --unsorted

# ==== Development ====

# Start development server with hot reload
[group('development')]
dev:
    uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# Install dependencies
[group('development')]
install:
    uv sync

# Install development dependencies
[group('development')]
install-dev:
    uv sync --dev

# ==== Code Quality ====

# Format code with ruff
[group('quality')]
fmt:
    uv run ruff format .
    uv run ruff check --fix .

# Lint code with ruff
[group('quality')]
lint:
    uv run ruff check .

# Type check with ty
[group('quality')]
ty:
    uv run ty check

# Run all quality checks
[group('quality')]
check: lint ty

# ==== Testing ====

# Run tests with pytest
[group('testing')]
test:
    uv run pytest -vv

# Run tests with coverage
[group('testing')]
test-cov:
    uv run pytest --cov=app --cov-report=term-missing --cov-report=html

# Run specific test file
[group('testing')]
test-file file:
    uv run pytest -vv {{file}}

# Run tests for infrastructure
[group('testing')]
test-infra:
    uv run pytest -vv tests/test_api_infrastructure.py

# Run health check tests
[group('testing')]
test-health:
    uv run pytest -vv tests/test_health.py

# ==== API Development ====

# Test API endpoints with curl
[group('api')]
test-endpoints:
    @echo "Testing basic health check..."
    @curl -s http://localhost:8000/api/v1/health/ | python -m json.tool
    @echo "\nTesting system info..."
    @curl -s http://localhost:8000/api/v1/system/info | python -m json.tool
    @echo "\nTesting API version..."
    @curl -s http://localhost:8000/api/v1/core/version | python -m json.tool

# Open API documentation
[group('api')]
docs:
    @echo "Opening API documentation at http://localhost:8000/docs"
    @open http://localhost:8000/docs || xdg-open http://localhost:8000/docs

# Validate OpenAPI schema
[group('api')]
validate-schema:
    @curl -s http://localhost:8000/openapi.json | python -m json.tool > /dev/null && echo "OpenAPI schema is valid"

# ==== Database ====

# Check database integration
[group('database')]
check-db:
    uv run python -m pytest tests/test_database_integration.py -v

# Test database health endpoint
[group('database')]
test-db-health:
    @curl -s http://localhost:8000/api/v1/health/database | python -m json.tool

# ==== Docker ====

# Build development Docker image
[group('docker')]
docker-build-dev:
    docker build -f Dockerfile.dev -t mr-kg-backend:dev .

# Build production Docker image
[group('docker')]
docker-build-prod:
    docker build -f Dockerfile -t mr-kg-backend:prod .

# Build all Docker images
[group('docker')]
docker-build: docker-build-dev docker-build-prod

# Run development Docker container
[group('docker')]
docker-run-dev:
    docker run --rm -p 8000:8000 --env-file .env.development -v $(pwd):/app mr-kg-backend:dev

# Run production Docker container
[group('docker')]
docker-run-prod:
    docker run --rm -p 8000:8000 --env-file .env.production mr-kg-backend:prod

# Start development stack with docker-compose
[group('docker')]
docker-dev:
    docker-compose up --build

# Start production stack with docker-compose
[group('docker')]
docker-prod:
    docker-compose -f docker-compose.prod.yml up --build -d

# Stop docker-compose stacks
[group('docker')]
docker-down:
    docker-compose down
    docker-compose -f docker-compose.prod.yml down

# View docker-compose logs
[group('docker')]
docker-logs service="":
    @if [ "{{service}}" = "" ]; then \
        docker-compose logs -f; \
    else \
        docker-compose logs -f {{service}}; \
    fi

# Clean up Docker resources
[group('docker')]
docker-clean:
    docker system prune -f
    docker image prune -f

# ==== Environment ====

# Create example environment file
[group('environment')]
env-example:
    @echo "Creating .env.example..."
    @echo "DEBUG=true" > .env.example
    @echo "HOST=0.0.0.0" >> .env.example
    @echo "PORT=8000" >> .env.example
    @echo "DB_PROFILE=local" >> .env.example
    @echo "VECTOR_STORE_PATH=../data/db/vector_store.db" >> .env.example
    @echo "TRAIT_PROFILE_PATH=../data/db/trait_profile_db.db" >> .env.example
    @echo "ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173" >> .env.example

# Copy environment example to .env if it doesn't exist
[group('environment')]
env-setup:
    @if [ ! -f .env ]; then cp .env.example .env; echo "Created .env from .env.example"; else echo ".env already exists"; fi

# ==== Infrastructure ====

# Run infrastructure validation
[group('infrastructure')]
validate-infra:
    @echo "Validating API infrastructure..."
    uv run pytest tests/test_api_infrastructure.py -v
    @echo "Testing middleware functionality..."
    @curl -s -I http://localhost:8000/api/v1/core/ping | grep -E "X-Request-ID|X-Process-Time|X-Content-Type-Options"

# Check all middleware headers
[group('infrastructure')]
check-middleware:
    @echo "Checking middleware headers..."
    @curl -s -I http://localhost:8000/api/v1/core/ping

# Test error handling
[group('infrastructure')]
test-errors:
    @echo "Testing 404 error handling..."
    @curl -s http://localhost:8000/nonexistent | python -m json.tool
    @echo "\nTesting method not allowed..."
    @curl -s -X POST http://localhost:8000/api/v1/core/ping | python -m json.tool

# ==== Performance ====

# Basic load test
[group('performance')]
load-test:
    @echo "Running basic load test (requires Apache Bench)..."
    @ab -n 100 -c 10 http://localhost:8000/api/v1/health/ || echo "Install Apache Bench (ab) for load testing"

# Profile API performance
[group('performance')]
profile:
    @echo "Testing response times..."
    @time curl -s http://localhost:8000/api/v1/health/ > /dev/null

# ==== Maintenance ====

# Clean up Python cache files
[group('maintenance')]
clean:
    find . -type f -name "*.pyc" -delete
    find . -type d -name "__pycache__" -delete
    find . -type d -name "*.egg-info" -exec rm -rf {} +
    rm -rf .pytest_cache/
    rm -rf htmlcov/

# Reset environment
[group('maintenance')]
reset: clean
    rm -f .env
    uv clean